# Document Numbering

**Category:** Documents  
**Status:** üü¢ Complete  
**Created:** 2024-12-12  
**Updated:** 2025-12-15  
**Source:** COMMON_DOCUMENT_PRINCIPLES.md

---

## Overview

Document numbering system with three number types:
- System number (document_number)
- Global sequence (global_sequence)  
- Book sequence (book_sequence)

---

## 1. ƒå√çSLOVANIE DOKLADOV

### 1.1 Koncept

Ka≈æd√Ω doklad v syst√©me m√° **tri typy ƒç√≠sel**:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. SYST√âMOV√â ƒå√çSLO (document_number)               ‚îÇ
‚îÇ    DD2500000123                                     ‚îÇ
‚îÇ    - Jedineƒçn√© v celom syst√©me                      ‚îÇ
‚îÇ    - Pou≈æ√≠va sa v √∫ƒçtovn√≠ctve a sklade              ‚îÇ
‚îÇ    - NIKDY sa nemen√≠                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. GLOB√ÅLNE PORADIE (global_sequence)              ‚îÇ
‚îÇ    123                                              ‚îÇ
‚îÇ    - Poradov√© ƒç√≠slo v r√°mci typu a roku             ‚îÇ
‚îÇ    - Bez medzier (1, 2, 3, 4, 5...)                 ‚îÇ
‚îÇ    - NIKDY sa nemen√≠                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. PORADIE V KNIHE (book_sequence)                 ‚îÇ
‚îÇ    1, 2, 3, 4...                                    ‚îÇ
‚îÇ    - Poradov√© ƒç√≠slo v r√°mci knihy a roku            ‚îÇ
‚îÇ    - Bez medzier v r√°mci knihy                      ‚îÇ
‚îÇ    - MEN√ç SA pri presune medzi knihami              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### 1.2 Syst√©mov√© ƒç√≠slo (document_number)

#### Form√°t
```
TTyy000nnnnn

TT   = Typ dokladu (DD, DF, OD, OF)
yy   = Rok (25 = 2025)
000  = Tri nuly (namiesto ƒç√≠sla knihy v starom syst√©me)
nnnnn = Glob√°lne poradov√© ƒç√≠slo (00001-99999)
```

#### Pr√≠klady
```
DD2500000001  - Dod√°vateƒæsk√Ω dodac√≠ list, rok 2025, poradie 1
DD2500000123  - Dod√°vateƒæsk√Ω dodac√≠ list, rok 2025, poradie 123
DF2500000001  - Dod√°vateƒæsk√° fakt√∫ra, rok 2025, poradie 1
OD2500000001  - Odberateƒæsk√Ω dodac√≠ list, rok 2025, poradie 1
OF2500000001  - Odberateƒæsk√° fakt√∫ra, rok 2025, poradie 1
```

#### SQL ≈°trukt√∫ra
```sql
document_number VARCHAR(13) NOT NULL UNIQUE,
document_type VARCHAR(2) NOT NULL CHECK (document_type IN ('DD', 'DF', 'OD', 'OF')),
year SMALLINT NOT NULL,
global_sequence INTEGER NOT NULL,

CONSTRAINT uq_year_global_sequence UNIQUE (year, global_sequence)
```

#### Generovanie
```python
def generate_document_number(document_type: str, year: int) -> tuple[str, int]:
    """
    Generuj syst√©mov√© ƒç√≠slo dokladu.
    
    Returns:
        (document_number, global_sequence)
    """
    # Z√≠ska≈• ƒèal≈°ie glob√°lne poradie
    sequence = get_next_global_sequence(document_type, year)
    
    # Format: TTyy000nnnnn
    document_number = f"{document_type}{year:02d}000{sequence:05d}"
    
    return (document_number, sequence)

# Pr√≠klad pou≈æitia
doc_num, seq = generate_document_number('DD', 2025)
# doc_num = 'DD2500000123'
# seq = 123
```

---

### 1.3 Glob√°lne poradie (global_sequence)

#### Koncept
- Jedineƒçn√© v r√°mci **typu dokladu** a **roku**
- Zaƒç√≠na od 1 ka≈æd√Ω rok
- Bez medzier: 1, 2, 3, 4, 5...
- Nikdy sa nemen√≠ (ani pri presune medzi knihami)

#### SQL ≈°trukt√∫ra
```sql
global_sequence INTEGER NOT NULL,

CONSTRAINT uq_year_global_sequence UNIQUE (year, global_sequence)
```

#### Generovanie
```sql
-- Funkcia na z√≠skanie ƒèal≈°ieho global_sequence
CREATE FUNCTION get_next_global_sequence(
    p_document_type VARCHAR(2),
    p_year SMALLINT
) RETURNS INTEGER AS $$
DECLARE
    v_sequence INTEGER;
BEGIN
    SELECT COALESCE(MAX(global_sequence), 0) + 1
    INTO v_sequence
    FROM supplier_delivery_heads  -- alebo in√° tabuƒæka
    WHERE document_type = p_document_type
      AND year = p_year;
    
    RETURN v_sequence;
END;
$$ LANGUAGE plpgsql;
```

---

### 1.4 Poradie v knihe (book_sequence)

#### Koncept
- Jedineƒçn√© v r√°mci **knihy**, **typu dokladu** a **roku**
- Zaƒç√≠na od 1 v ka≈ædej knihe
- Bez medzier v r√°mci knihy: 1, 2, 3, 4, 5...
- **Automaticky prepoƒç√≠tan√©** pri presune medzi knihami
- Len **informat√≠vne pre pou≈æ√≠vateƒæov**

#### SQL ≈°trukt√∫ra
```sql
book_num INTEGER NOT NULL,
book_sequence INTEGER NOT NULL,

CONSTRAINT uq_book_sequence UNIQUE (book_num, year, book_sequence)
```

#### Automatick√© generovanie (Trigger)
```sql
CREATE OR REPLACE FUNCTION recalculate_book_sequence()
RETURNS TRIGGER AS $$
BEGIN
    -- Pri INSERT - priradi≈• ƒèal≈°ie poradov√© ƒç√≠slo v knihe
    IF TG_OP = 'INSERT' THEN
        SELECT COALESCE(MAX(book_sequence), 0) + 1
        INTO NEW.book_sequence
        FROM supplier_delivery_heads  -- alebo in√° tabuƒæka
        WHERE book_num = NEW.book_num
          AND document_type = NEW.document_type
          AND year = NEW.year;
        
        RETURN NEW;
    END IF;
    
    -- Pri UPDATE (zmena book_num) - prepoƒç√≠ta≈• v oboch knih√°ch
    IF TG_OP = 'UPDATE' AND OLD.book_num != NEW.book_num THEN
        -- Prepoƒç√≠ta≈• star√∫ knihu (uzavrie≈• medzeru)
        UPDATE supplier_delivery_heads
        SET book_sequence = book_sequence - 1
        WHERE book_num = OLD.book_num
          AND document_type = OLD.document_type
          AND year = OLD.year
          AND book_sequence > OLD.book_sequence;
        
        -- Priradi≈• nov√© poradie v novej knihe
        SELECT COALESCE(MAX(book_sequence), 0) + 1
        INTO NEW.book_sequence
        FROM supplier_delivery_heads
        WHERE book_num = NEW.book_num
          AND document_type = NEW.document_type
          AND year = NEW.year;
        
        RETURN NEW;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger
CREATE TRIGGER trg_recalculate_book_sequence
    BEFORE INSERT OR UPDATE ON supplier_delivery_heads
    FOR EACH ROW
    EXECUTE FUNCTION recalculate_book_sequence();
```

#### Pr√≠klad presunu dokladu
```
PRED PRESUNOM:
Kniha 1 (Ko≈°ice):           Kniha 2 (Kom√°rno):
  DD2500000001  #1            DD2500000002  #1
  DD2500000005  #2  ‚Üê tento  DD2500000003  #2
  DD2500000009  #3            DD2500000007  #3

PO PRESUNE DD2500000005 z Ko≈°√≠c do Kom√°rna:
Kniha 1 (Ko≈°ice):           Kniha 2 (Kom√°rno):
  DD2500000001  #1            DD2500000002  #1
  DD2500000009  #2 (prepoƒç√≠tan√©) DD2500000003  #2
                              DD2500000005  #3 (nov√©)
                              DD2500000007  #4 (prepoƒç√≠tan√©)

Syst√©mov√© ƒç√≠slo DD2500000005 zostalo NEZMENEN√â!
```

---

### 1.5 Migr√°cia star√Ωch ƒç√≠sel

#### Star√Ω syst√©m (NEX Genesis)
```
TSH25001.BTR ‚Üí Kniha 1, rok 2025
  DocNum = DD2500100123
           ‚îÇ‚îÇ‚îÇ‚îÇ‚îÇ‚îÇ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Poradie v knihe (123)
           ‚îÇ‚îÇ‚îÇ‚îÇ‚îÇ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ƒå√≠slo knihy (001)
           ‚îÇ‚îÇ‚îÇ‚îÇ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Rok (25)
           ‚îÇ‚îÇ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Typ (DD)
```

#### Nov√Ω syst√©m (NEX Automat)
```sql
CREATE TABLE supplier_delivery_heads (
    document_number VARCHAR(13),      -- DD2500000123 (nov√©)
    old_document_number VARCHAR(13),  -- DD2500100123 (star√©, pre hist√≥riu)
    
    year SMALLINT,                    -- 2025
    global_sequence INTEGER,          -- 123
    book_num INTEGER,                 -- 1
    book_sequence INTEGER,            -- Auto-generovan√©
    ...
)
```

#### Migraƒçn√Ω k√≥d
```python
def migrate_document_number(old_doc_num: str, year: int, book_num: int):
    """
    Migruj star√© ƒç√≠slo dokladu na nov√©.
    
    Args:
        old_doc_num: DD2500100123 (star√© ƒç√≠slo)
        year: 2025
        book_num: 1
    
    Returns:
        (new_doc_num, global_sequence)
    """
    # Parse star√© ƒç√≠slo
    # DD2500100123
    doc_type = old_doc_num[0:2]      # DD
    old_year = int(old_doc_num[2:4])  # 25
    old_book = int(old_doc_num[4:7])  # 001
    old_seq = int(old_doc_num[7:12])  # 00123
    
    # Z√≠ska≈• ƒèal≈°√≠ global_sequence
    global_seq = get_next_global_sequence(doc_type, year)
    
    # Generuj nov√© ƒç√≠slo
    new_doc_num = f"{doc_type}{year:02d}000{global_seq:05d}"
    
    return (new_doc_num, global_seq, old_doc_num)

# Pr√≠klad
new, seq, old = migrate_document_number('DD2500100123', 2025, 1)
# new = 'DD2500000456'  (nov√© glob√°lne poradie)
# seq = 456
# old = 'DD2500100123'  (zachovan√© pre hist√≥riu)
```

---

---

## 3. KNIHY DOKLADOV

### 3.1 Koncept

**Kniha dokladov** = logick√° organizaƒçn√° jednotka, podobn√° ≈°an√≥nu alebo zlo≈æke.

**Pou≈æitie:**
- Oddelenie dokladov podƒæa prev√°dzok (Ko≈°ice, Kom√°rno, Bratislava)
- Oddelenie dokladov podƒæa typu ƒçinnosti
- Centr√°lne ƒç√≠slovanie v r√°mci viacer√Ωch prev√°dzok

---

### 3.2 Star√Ω syst√©m (NEX Genesis)

```
Ka≈æd√° kniha = samostatn√Ω s√∫bor

TSH25001.BTR  ‚Üê Kniha ƒç. 1, rok 2025
TSH25002.BTR  ‚Üê Kniha ƒç. 2, rok 2025
TSH25003.BTR  ‚Üê Kniha ƒç. 3, rok 2025
TSH24001.BTR  ‚Üê Kniha ƒç. 1, rok 2024
```

**ƒå√≠slovanie:**
```
Kniha 1: DocNum = DD2500100001, DD2500100002, DD2500100003
                         ‚Üë‚Üë‚Üë
                    ƒç√≠slo knihy v syst√©movom ƒç√≠sle
```

---

### 3.3 Nov√Ω syst√©m (NEX Automat)

```
Jedna tabuƒæka + stƒ∫pec book_num

supplier_delivery_heads (
    book_num INTEGER NOT NULL,
    ...
)
```

**ƒå√≠slovanie:**
```
Kniha 1: DocNum = DD2500000001, DD2500000005, DD2500000009
Kniha 2: DocNum = DD2500000002, DD2500000006, DD2500000010
                         ‚Üë‚Üë‚Üë
                    tri nuly (glob√°lne ƒç√≠slovanie)
```

---

### 3.4 SQL ≈°trukt√∫ra

```sql
CREATE TABLE supplier_delivery_heads (
    book_num INTEGER NOT NULL,                -- ƒå√≠slo knihy
    book_sequence INTEGER NOT NULL,           -- Poradie v knihe
    
    CONSTRAINT uq_book_sequence UNIQUE (book_num, year, book_sequence),
    
    -- FK na ƒç√≠seln√≠k kn√≠h (nesk√¥r)
    -- FOREIGN KEY (book_num) REFERENCES document_books(book_num)
)
```

---

### 3.5 Migr√°cia z Btrieve

```python
def migrate_tsh_file(filename: str):
    """
    Migruj TSH s√∫bor.
    
    Args:
        filename: TSH25001.BTR
    """
    # Parse n√°zov s√∫boru
    match = re.match(r'TSH(\d{2})(\d{3})\.BTR', filename)
    year = 2000 + int(match.group(1))  # 25 ‚Üí 2025
    book_num = int(match.group(2))      # 001 ‚Üí 1
    
    # Migruj v≈°etky z√°znamy z tohto s√∫boru
    for record in read_btrieve_file(filename):
        migrate_delivery_head(record, year, book_num)
```

---

### 3.6 Konfiguraƒçn√© parametre kn√≠h

**[NEVIEM]** Podrobn√° ≈°trukt√∫ra ƒç√≠seln√≠ka `document_books` bude definovan√° v samostatnej dokument√°cii.

**Z√°kladn√° ≈°trukt√∫ra (orientaƒçne):**
```sql
document_books (
    book_num INTEGER PRIMARY KEY,
    book_name VARCHAR(100),
    document_type VARCHAR(2),
    year SMALLINT,
    facility_id INTEGER,
    is_active BOOLEAN,
    settings JSONB
)
```

---

---

## 4. LIFECYCLE DOKLADOV (V≈†EOBECN√ù KONCEPT)

### 4.1 Princ√≠p

Ka≈æd√Ω typ dokladu m√° **vlastn√Ω lifecycle** a **≈°pecifick√© stavy**.

Stavy s√∫ ≈†PECIFICK√â pre ka≈æd√Ω typ dokladu a s√∫ podrobne pop√≠san√© v pr√≠slu≈°nom dokumente (TSH.md, TSI.md, DF.md, OD.md...).

---

### 4.2 Pr√≠klady lifecycles

**Dod√°vateƒæsk√© dodacie listy:**
```
draft ‚Üí received ‚Üí posted
```

**Dod√°vateƒæsk√© fakt√∫ry:**
```
draft ‚Üí confirmed ‚Üí paid ‚Üí posted
```

**Odberateƒæsk√© dodacie listy:**
```
draft ‚Üí confirmed ‚Üí shipped ‚Üí delivered
```

**Objedn√°vky:**
```
draft ‚Üí confirmed ‚Üí partially_delivered ‚Üí delivered ‚Üí closed
```

---

### 4.3 Kde n√°js≈• detail

**Detail stavov a lifecycle pre konkr√©tny typ dokladu pozri v:**
- `TSH-supplier_delivery_heads.md` (dod√°vateƒæsk√© dodacie listy)
- `DF-supplier_invoice_heads.md` (dod√°vateƒæsk√© fakt√∫ry)
- `OD-customer_delivery_heads.md` (odberateƒæsk√© dodacie listy)
- atƒè.

---

---

## 5. DVOJMENN√Å ARCHITEKT√öRA (AC/FC)

### 5.1 Koncept

Ka≈æd√° hodnota existuje v **dvoch men√°ch**:
- **AC** (Accounting Currency) - √öƒçtovn√° mena (EUR)
- **FC** (Foreign Currency) - Vy√∫ƒçtovacia mena (USD, CZK...)

---

### 5.2 ≈†trukt√∫ra

```sql
-- Meny
accounting_currency VARCHAR(3) NOT NULL DEFAULT 'EUR',  -- AC
foreign_currency VARCHAR(3),                            -- FC
foreign_currency_rate DECIMAL(15,6),                    -- Kurz

-- Hodnoty v √∫ƒçtovnej mene (AC)
purchase_base_value_ac DECIMAL(15,2),
purchase_total_value_ac DECIMAL(15,2),

-- Hodnoty vo vy√∫ƒçtovacej mene (FC)
purchase_base_value_fc DECIMAL(15,2),
purchase_total_value_fc DECIMAL(15,2)
```

---

### 5.3 Valid√°cia

```sql
-- Vy√∫ƒçtovacia mena len ak je zadan√°
CHECK (
    (foreign_currency IS NULL AND foreign_currency_rate IS NULL) OR
    (foreign_currency IS NOT NULL AND foreign_currency_rate IS NOT NULL)
)

-- Hodnoty vo vy√∫ƒçtovacej mene len ak je mena zadan√°
CHECK (
    foreign_currency IS NULL OR
    (purchase_base_value_fc IS NOT NULL AND purchase_total_value_fc IS NOT NULL)
)

-- Kurz meny > 0
CHECK (foreign_currency_rate IS NULL OR foreign_currency_rate > 0)
```

---

### 5.4 Prepoƒçet

```python
def calculate_fc_values(ac_value: Decimal, rate: Decimal) -> Decimal:
    """
    Prepoƒç√≠taj hodnotu z AC na FC.
    
    Args:
        ac_value: Hodnota v √∫ƒçtovnej mene (EUR)
        rate: Kurz meny (napr. 1.1 pre USD)
    
    Returns:
        Hodnota vo vy√∫ƒçtovacej mene
    """
    return ac_value * rate

# Pr√≠klad
ac_value = Decimal('1000.00')  # EUR
rate = Decimal('1.10')          # USD kurz
fc_value = calculate_fc_values(ac_value, rate)
# fc_value = 1100.00 USD
```

---

---

**See Also:**
- [DOCUMENT_TYPES.md](DOCUMENT_TYPES.md) - Document types
- [../database/DATABASE_PRINCIPLES.md](../database/DATABASE_PRINCIPLES.md) - Database design
