name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      customer:
        description: 'Target customer environment'
        required: true
        type: choice
        options:
          - ANDROS
          - MAGER

env:
  SRC_DIR: /opt/nex-automat-src
  DEPLOY_DIR: /opt/nex-automat

jobs:
  deploy:
    name: Deploy to ${{ inputs.customer }}
    runs-on:
      - self-hosted
      - ${{ inputs.customer }}
    environment: production-${{ inputs.customer }}
    defaults:
      run:
        working-directory: /opt/nex-automat

    steps:
      - name: Pull latest code
        run: |
          echo "Pulling latest code from repository..."
          cd /opt/nex-automat-src
          git pull

      - name: Build images
        run: |
          echo "Building Docker images..."
          docker compose build nex-brain nex-telegram

      - name: Deploy services
        run: |
          echo "Deploying services for ${{ inputs.customer }}..."
          docker compose up -d nex-brain nex-telegram

      - name: Health check
        run: |
          echo "Waiting for services to start..."
          sleep 10
          echo "Running health check..."
          curl -f http://localhost:8000/health || exit 1
          echo "Health check passed!"

      - name: Deployment summary
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Customer | ${{ inputs.customer }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Running Containers" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker compose ps >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
