name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      customer:
        description: 'Target customer environment'
        required: true
        type: choice
        options:
          - ANDROS
          - MAGER

jobs:
  deploy:
    name: Deploy to ${{ inputs.customer }}
    runs-on:
      - self-hosted
      - ${{ inputs.customer }}
    environment: production-${{ inputs.customer }}

    steps:
      - name: Pull latest code
        uses: appleboy/ssh-action@v1
        with:
          host: 172.17.0.1
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "Pulling latest code..."
            cd /opt/nex-automat-src
            git pull

      - name: Build images
        uses: appleboy/ssh-action@v1
        with:
          host: 172.17.0.1
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "Building Docker images..."
            cd /opt/nex-automat
            docker compose build nex-brain nex-telegram

      - name: Deploy services
        uses: appleboy/ssh-action@v1
        with:
          host: 172.17.0.1
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "Deploying services..."
            cd /opt/nex-automat
            docker compose up -d nex-brain nex-telegram

      - name: Health check
        uses: appleboy/ssh-action@v1
        with:
          host: 172.17.0.1
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "Waiting for services..."
            sleep 10
            echo "Running health check..."
            curl -f http://localhost:8000/health
            echo "Health check passed!"

      - name: Deployment summary
        uses: appleboy/ssh-action@v1
        with:
          host: 172.17.0.1
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "=== Running Containers ==="
            cd /opt/nex-automat
            docker compose ps
