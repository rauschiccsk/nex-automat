name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      customer:
        description: 'Target customer environment'
        required: true
        type: choice
        options:
          - ANDROS
          - MAGER

jobs:
  # ===========================================
  # ANDROS Deployment (Linux)
  # ===========================================
  deploy-andros:
    name: Deploy to ANDROS
    if: inputs.customer == 'ANDROS'
    runs-on:
      - self-hosted
      - ANDROS
    environment: production-ANDROS

    steps:
      - name: Pull latest code
        uses: appleboy/ssh-action@v1
        with:
          host: 172.17.0.1
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "Pulling latest code..."
            cd /opt/nex-automat-src
            git pull

      - name: Build images
        uses: appleboy/ssh-action@v1
        with:
          host: 172.17.0.1
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "Building Docker images..."
            cd /opt/nex-automat
            docker compose build nex-brain nex-telegram

      - name: Deploy services
        uses: appleboy/ssh-action@v1
        with:
          host: 172.17.0.1
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "Deploying services..."
            cd /opt/nex-automat
            docker compose up -d nex-brain nex-telegram

      - name: Health check
        uses: appleboy/ssh-action@v1
        with:
          host: 172.17.0.1
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "Waiting for services..."
            sleep 10
            echo "Running health check..."
            curl -f http://localhost:8000/health
            echo "Health check passed!"

      - name: Deployment summary
        uses: appleboy/ssh-action@v1
        with:
          host: 172.17.0.1
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "=== Running Containers ==="
            cd /opt/nex-automat
            docker compose ps

  # ===========================================
  # MAGER Deployment (Windows + Btrieve Hybrid)
  # ===========================================
  deploy-mager:
    if: github.event.inputs.customer == 'MAGER'
    runs-on: [self-hosted, MAGER]
    environment: production-MAGER

    steps:
      - name: Git Pull
        shell: powershell
        run: |
          cd C:\opt\nex-automat-src
          git pull origin develop

      - name: Copy Docker Compose
        shell: powershell
        run: |
          Copy-Item C:\opt\nex-automat-src\deploy\mager\docker-compose.yml C:\opt\nex-automat\ -Force

      - name: Docker Compose Up
        shell: powershell
        run: |
          cd C:\opt\nex-automat
          docker compose pull
          docker compose up -d

      - name: Restart Btrieve-Loader
        shell: powershell
        run: |
          Restart-Service NEX-SupplierInvoiceLoader -ErrorAction SilentlyContinue

      - name: Health Check
        shell: powershell
        run: |
          cd C:\opt\nex-automat
          docker compose ps
